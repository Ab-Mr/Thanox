{
  "author": "诗里沧海怨怼",
  "version": 1,
  "tags": [
    "app_opt"
  ],
  "profile": {
    "name": "多开后台管家",
    "description": "by诗里沧海怨怼 | 延时[瘦身|停止]后台应用,可重计时 | 要求灭霸版本4.2.0+",
    "priority": -1,
    "condition": "systemReady||shortcutLaunched&&shortcutValue=='trimOn'",
    "actions": [
      "import java.util.HashMap;import java.util.HashSet;import java.nio.file.Paths;import java.nio.file.Files;import java.nio.file.StandardOpenOption;long _cycleTime=1*60000;_userId='0';ui.showShortToast('多开后台管家已开启');io.write('starlee/zero','0');Thread.sleep(4000);int cnt1=0;fp=thanos.profileManager.getLogPath();fp=fp.substring(0,fp.length()-38);fc=java.nio.channels.FileChannel.open(Paths.get(fp,'profile_user_io/starlee/threadID'),StandardOpenOption.READ,StandardOpenOption.WRITE,StandardOpenOption.CREATE);mylock=fc.lock();mbuff=java.nio.ByteBuffer.allocate(10);fc.read(mbuff);rstr=new String(mbuff.array(),0,mbuff.position(),java.nio.charset.StandardCharsets.UTF_8);mbuff=null;if(rstr!=''){id=Long.valueOf(rstr);iter=Thread.getAllStackTraces().keySet().iterator();t=iter.next();while(iter.hasNext()&&(id!=t.id)){if(++cnt1==50){Thread.sleep(150);cnt1=0;}t=iter.next();}if(t.id==id&&t.name.contains('后台管家')){t.interrupt();}}fc.truncate(0);Thread.currentThread().setPriority(Thread.MAX_PRIORITY);fc.write(java.nio.ByteBuffer.wrap(String.valueOf(Thread.currentThread().id).bytes));mylock.release();fc.close();cMap=new HashMap();uMap=new HashMap();rMap=new HashMap();cntMap=new HashMap();sbTrim=new StringBuilder();sbKill=new StringBuilder();long minV=Long.MAX_VALUE;sbTrim.append('|trimApp|\n');for(str:globalVarOf$trimApp){if(++cnt1==50){Thread.sleep(200);cnt1=0;}if(str!=null){sbTrim.append(str+'\n');mtime=0;if(str.charAt(str.length()-1)=='@'){mtime=4;str=str.substring(0,str.length()-1);}strs=str.split(' ');tmp=strs[strs.length-1];if(strs.length==1){mtime+=_cycleTime;cMap.put(strs[0],mtime);cp=Paths.get(fp,'profile_user_io/starlee/',_userId,strs[0]);uMap.put(cp,Integer.valueOf(_userId));rMap.put(cp,System.currentTimeMillis());}else if(tmp.contains('#')){strs1=tmp.split('#');if(strs1.length==1){mtime+=_cycleTime;}else{strs2=strs1[1].split(',');if(strs2.length>1){trimCnt=Integer.valueOf(strs2[1]);cntMap.put(strs[0],new int[]{trimCnt,trimCnt});}mtime+=Math.max(30,Long.valueOf(strs2[0]))*1000;}cMap.put(strs[0],mtime);for(id:strs1[0].split(',')){if(++cnt1==50){Thread.sleep(200);cnt1=0;}cp=Paths.get(fp,'profile_user_io/starlee/',id,strs[0]);uMap.put(cp,Integer.valueOf(id));rMap.put(cp,System.currentTimeMillis());}}else{strs1=tmp.split(',');if(strs1.length>1){trimCnt=Integer.valueOf(strs1[1]);cntMap.put(strs[0],new int[]{trimCnt,trimCnt});}mtime+=Math.max(30,Long.valueOf(strs1[0]))*1000;cMap.put(strs[0],mtime);cp=Paths.get(fp,'profile_user_io/starlee/',_userId,strs[0]);uMap.put(cp,Integer.valueOf(_userId));rMap.put(cp,System.currentTimeMillis());}minV=Math.min(minV,mtime);}}sbTrim.append('|killApp|\n');for(str:globalVarOf$killApp){if(++cnt1==50){Thread.sleep(200);cnt1=0;}if(str!=null){sbTrim.append(str+'\n');mtime=1;if(str.charAt(str.length()-1)=='@'){mtime+=4;str=str.substring(0,str.length()-1);}strs=str.split(' ');tmp=strs[strs.length-1];if(strs.length==1){mtime+=_cycleTime;cMap.put(strs[0],mtime);cp=Paths.get(fp,'profile_user_io/starlee/',_userId,strs[0]);uMap.put(cp,Integer.valueOf(_userId));rMap.put(cp,System.currentTimeMillis());}else if(tmp.contains('#')){strs1=tmp.split('#');mtime+=(strs1.length==1?_cycleTime:Math.max(30,Long.valueOf(strs1[1]))*1000);cMap.put(strs[0],mtime);foreach(id:strs1[0].split(',')){if(++cnt1==50){Thread.sleep(200);cnt1=0;}cp=Paths.get(fp,'profile_user_io/starlee/',id,strs[0]);uMap.put(cp,Integer.valueOf(id));rMap.put(cp,System.currentTimeMillis());}}else{mtime+=Math.max(30,Long.valueOf(tmp))*1000;cMap.put(strs[0],mtime);cp=Paths.get(fp,'profile_user_io/starlee/',_userId,strs[0]);uMap.put(cp,Integer.valueOf(_userId));rMap.put(cp,System.currentTimeMillis());}minV=Math.min(minV,mtime);}}sbTrim.append('|musicApp|\n');for(str:globalVarOf$musicApp){if(++cnt1==50){Thread.sleep(200);cnt1=0;}if(str!=null){sbTrim.append(str+'\n');mtime=2;if(str.charAt(str.length()-1)=='@'){mtime+=4;str=str.substring(0,str.length()-1);}strs=str.split(' ');mtime+=strs.length==1?_cycleTime:Math.max(30,Long.valueOf(strs[strs.length-1]))*1000;cMap.put(strs[0],mtime);cp=Paths.get(fp,'profile_user_io/starlee/',_userId,strs[0]);uMap.put(cp,Integer.valueOf(_userId));rMap.put(cp,System.currentTimeMillis());minV=Math.min(minV,mtime);}}if(cMap.size()==0){return;}aSet=new HashSet();tSet=new HashSet();noSet=new HashSet();sbTrim.append('|audioApp|\n');for(str:globalVarOf$audioApp){if(++cnt1==50){Thread.sleep(250);cnt1=0;}if(str!=null){sbTrim.append(str+'\n');aSet.add(str.split(' ')[0]);}}sbTrim.append('|topApp|\n');for(str:globalVarOf$topApp){if(++cnt1==50){Thread.sleep(250);cnt1=0;}if(str!=null){sbTrim.append(str+'\n');tSet.add(str.split(' ')[0]);}}sbTrim.append('|noTrimProcess|\n');for(str:globalVarOf$noTrimProcess){if(++cnt1==50){Thread.sleep(250);cnt1=0;}if(str!=null){sbTrim.append(str+'\n');noSet.add(str);}}io.write('管家变量.info',sbTrim.toString());sbTrim.setLength(0);pat=java.time.format.DateTimeFormatter.ofPattern('MM/dd HH:mm:ss');infoArray=new String[20];procIds=new long[20];logN='多开后台管家.log';long st=100;aMan=thanos.activityManager;io.writeAppend(logN,'=============管家初始化完成=============\n');while(true){Thread.sleep(st);sbKill.append('时间: ').append(java.time.LocalDateTime.now().format(pat)).append('\n正使用: ').append(activity.frontAppPackage).append('\n|清理掉的后台|\n');sbTrim.append('|瘦身掉的进程|\n');minT=minV;st=0;curT=System.currentTimeMillis();tork=false;for(entry:rMap.entrySet()){if(++cnt1==50){Thread.sleep(150);cnt1=0;}cp=(java.nio.file.Path)entry.key;ltt=(long)entry.value;name=cp.fileName.toString();if(Files.exists(cp)){lttOld=ltt;ltt=Math.max(Files.getLastModifiedTime(cp).toMillis(),ltt);if(lttOld!=ltt){ints=cntMap.get(name);if(ints!=null){ints[0]=ints[1];}}}cn=(long)cMap.get(name);ntT=ltt+cn-curT;if(ntT<=2500){id=(int)uMap.get(cp);curPkg=Pkg.newPkg(name,id);if(aMan.isPackageRunning(curPkg)){if(!activity.frontAppPackage.equals(name)){isplay=thanos.audioManager.hasAudioFocus(curPkg);isTrim=true;skip=true;if((cn&2)!=0){if(isplay){skip=false;}else{param=tSet.contains(name)?'t':'f';param1=(cn&4)!=0?'t':'f';thanos.profileManager.publishStringFact(1,'musicKill',10000,new String[]{name,param,param1});}}else{isTrim=(cn&1)==0;if(isTrim){ints=cntMap.get(name);if(ints!=null){if(ints[0]==0){isTrim=false;ints[0]=ints[1];}else{ints[0]=ints[0]-1;}}}skip=aSet.contains(name)&&isplay||tSet.contains(name)&&aMan.hasTopVisibleActivities(curPkg)||(cn&4)!=0&&thanos.notificationManager.hasShowingNotificationRecordsForPackage(curPkg);}if(!skip){if(isTrim){int infoCnt=0;infoArray[infoCnt++]=String.valueOf(id);for(proc:aMan.getRunningAppProcessForPackage(curPkg)){if(!noSet.contains(proc.processName)){procIds[infoCnt]=proc.pid;infoArray[infoCnt++]=proc.processName;}}if(infoCnt>1){thanos.profileManager.publishStringFact(1,'backAppTrim',0,java.util.Arrays.copyOf(infoArray,infoCnt));sbTrim.append('{userId:').append(id).append('}\n');for(int i=1;i<infoCnt;i++){sbTrim.append(procIds[i]).append(' ').append(infoArray[i]).append('\n');}tork=true;}}else{aMan.forceStopPackage(curPkg,'管家出手,直接没有~');sbKill.append(name).append('{userId:').append(id).append('}\n');tork=true;}}}rMap.put(cp,curT);}}else if(ntT<=10000){st=10000;}else{minT=Math.min(minT,ntT);}}st=(st!=0)?st:minT;if(tork){sbTrim.append('---------------\n');io.writeAppend(logN,sbKill.toString()+sbTrim.toString());}sbTrim.setLength(0);sbKill.setLength(0);}"
    ]
  }
}
